# Elixir CircleCI 2.0 configuration file

version: 2
jobs:
  build:
    docker:
      - image: joeellis/elixir-phoenix-node:1.0
        environment:
          - MIX_ENV=test
          - DB_USER=linklet
          - DB_PASSWORD=secret
          - DB_DATABASE=linklet
      - image: mysql:8
        environment:
          - MYSQL_USER=linklet
          - MYSQL_PASSWORD=secret
          - MYSQL_DATABASE=linklet
          - MYSQL_ROOT_PASSWORD=secret

    working_directory: ~/repo
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-mix-cache-{{ .Branch }}-{{ checksum "mix.lock" }}
            - v1-mix-cache-{{ .Branch }}
            - v1-mix-cache
      - restore_cache:
          keys:
            - v1-build-cache-{{ .Branch }}
            - v1-build-cache
      - run: mix do deps.get, compile
      - save_cache:
          key: v1-mix-cache-{{ .Branch }}-{{ checksum "mix.lock" }}
          paths: "deps"
      - save_cache:
          key: v1-mix-cache-{{ .Branch }}
          paths: "deps"
      - save_cache:
          key: v1-mix-cache
          paths: "deps"
      - save_cache:
          key: v1-build-cache-{{ .Branch }}
          paths: "_build"
      - save_cache:
          key: v1-build-cache
          paths: "_build"
      - run:
          working_directory: frontend
          command: yarn install && yarn test && yarn build
      - run: mix ecto.create && mix ecto.migrate
      - run: mix test